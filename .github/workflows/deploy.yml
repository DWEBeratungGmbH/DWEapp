name: CI/CD Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manuell starten

env:
  SERVER_IP: 91.98.135.191

jobs:
  # =============================================
  # STEP 1: Build & Test lokal
  # =============================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: TypeScript Check
        run: npx tsc --noEmit

      - name: Build Test
        run: npm run build
        env:
          NEXT_PUBLIC_WECLAPP_API_URL: https://dwe.weclapp.com/webapp/api/v2

  # =============================================
  # STEP 2: Deploy auf Server (nur wenn Build OK)
  # =============================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to Production
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ env.SERVER_IP }} << 'DEPLOY'
            set -e
            cd /opt/weclapp-manager
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "ðŸ”¨ Building dweapp container..."
            docker-compose build --no-cache dweapp
            
            echo "ðŸš€ Restarting dweapp..."
            docker-compose up -d --force-recreate dweapp nginx
            
            echo "ðŸ§¹ Cleaning old images..."
            docker image prune -f
            
            echo "âœ… Deployment completed!"
            docker-compose ps
          DEPLOY

      - name: Health Check
        run: |
          sleep 20
          curl -k -f https://${{ env.SERVER_IP }} || echo "âš ï¸ Health check failed"

      - name: Success
        run: echo "ðŸš€ Deployed to https://${{ env.SERVER_IP }}"
