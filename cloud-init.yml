#cloud-config
package_update: true
package_upgrade: true

# Packages installieren
packages:
  - docker.io
  - docker-compose
  - nginx
  - certbot
  - python3-certbot-nginx
  - git
  - curl
  - ufw
  - htop
  - fail2ban

# Docker und Docker Compose konfigurieren
runcmd:
  # Docker starten und zum Boot hinzuf√ºgen
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker root
  
  # Docker Compose installieren (falls nicht im Paket)
  - curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  
  # Firewall konfigurieren
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable
  
  # App Verzeichnis erstellen
  - mkdir -p /opt/weclapp-manager
  
  # GitHub clone vorbereiten
  - cd /opt/weclapp-manager
  
  # Fail2ban konfigurieren
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Nginx Grundkonfiguration
  - rm -f /etc/nginx/sites-enabled/default
  - systemctl enable nginx
  - systemctl start nginx

# Dateien erstellen
write_files:
  # Docker Compose Template
  - path: /opt/weclapp-manager/docker-compose.yml.template
    permissions: '0644'
    content: |
      version: '3.8'
      
      services:
        weclapp-manager:
          image: ${DOCKER_IMAGE:-weclapp-manager:latest}
          ports:
            - "3000:3000"
          environment:
            - NODE_ENV=production
            - NEXT_PUBLIC_WECLAPP_API_URL=${WECLAPP_API_URL}
            - NEXT_PUBLIC_WECLAPP_API_KEY=${WECLAPP_API_KEY}
            - NEXT_PUBLIC_AZURE_AD_CLIENT_ID=${AZURE_CLIENT_ID}
            - NEXT_PUBLIC_AZURE_AD_TENANT_ID=${AZURE_TENANT_ID}
            - NEXT_PUBLIC_REDIRECT_URI=${APP_URL}
            - NEXT_PUBLIC_CLOCKIN_API_URL=${CLOCKIN_API_URL}
            - NEXT_PUBLIC_CLOCKIN_API_KEY=${CLOCKIN_API_KEY}
            - NEXTAUTH_URL=${APP_URL}
            - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
          restart: unless-stopped
          networks:
            - app-network
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
      
        nginx:
          image: nginx:alpine
          ports:
            - "80:80"
            - "443:443"
          volumes:
            - /opt/weclapp-manager/nginx.conf:/etc/nginx/nginx.conf
            - /opt/weclapp-manager/ssl:/etc/nginx/ssl
            - /etc/letsencrypt:/etc/letsencrypt:ro
          depends_on:
            - weclapp-manager
          restart: unless-stopped
          networks:
            - app-network
      
      networks:
        app-network:
          driver: bridge
      
      volumes:
        ssl:

  # Nginx Konfiguration Template
  - path: /opt/weclapp-manager/nginx.conf.template
    permissions: '0644'
    content: |
      events {
          worker_connections 1024;
      }
      
      http {
          upstream app {
              server weclapp-manager:3000;
          }
      
          # HTTP to HTTPS redirect
          server {
              listen 80;
              server_name ${DOMAIN};
              return 301 https://$server_name$request_uri;
          }
      
          # HTTPS server
          server {
              listen 443 ssl http2;
              server_name ${DOMAIN};
      
              # SSL Configuration
              ssl_certificate /etc/nginx/ssl/cert.pem;
              ssl_certificate_key /etc/nginx/ssl/key.pem;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;
              ssl_prefer_server_ciphers on;
      
              # Security headers
              add_header X-Frame-Options DENY;
              add_header X-Content-Type-Options nosniff;
              add_header X-XSS-Protection "1; mode=block";
              add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
      
              # Gzip compression
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_proxied expired no-cache no-store private must-revalidate auth;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript;
      
              location / {
                  proxy_pass http://app;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
          }
      }

  # Deployment Script
  - path: /opt/weclapp-manager/deploy.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      
      set -e
      
      echo "üöÄ Starting WeClapp Manager deployment..."
      
      # Variablen
      DOCKER_IMAGE="${1:-weclapp-manager:latest}"
      DOMAIN="${2:-localhost}"
      
      # Environment Datei erstellen
      cat > /opt/weclapp-manager/.env << EOF
      DOCKER_IMAGE=$DOCKER_IMAGE
      DOMAIN=$DOMAIN
      WECLAPP_API_URL=$WECLAPP_API_URL
      WECLAPP_API_KEY=$WECLAPP_API_KEY
      AZURE_CLIENT_ID=$AZURE_CLIENT_ID
      AZURE_TENANT_ID=$AZURE_TENANT_ID
      APP_URL=https://$DOMAIN
      CLOCKIN_API_URL=$CLOCKIN_API_URL
      CLOCKIN_API_KEY=$CLOCKIN_API_KEY
      NEXTAUTH_SECRET=$NEXTAUTH_SECRET
      EOF
      
      # Docker Compose konfigurieren
      envsubst < /opt/weclapp-manager/docker-compose.yml.template > /opt/weclapp-manager/docker-compose.yml
      envsubst < /opt/weclapp-manager/nginx.conf.template > /opt/weclapp-manager/nginx.conf
      
      # SSL Zertifikate einrichten
      if [ ! -f "/etc/nginx/ssl/cert.pem" ] && [ "$DOMAIN" != "localhost" ]; then
          mkdir -p /etc/nginx/ssl
          certbot --nginx -d $DOMAIN --non-interactive --agree-tos --email admin@$DOMAIN || true
          
          # Zertifikate kopieren falls vorhanden
          if [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
              cp /etc/letsencrypt/live/$DOMAIN/fullchain.pem /etc/nginx/ssl/cert.pem
              cp /etc/letsencrypt/live/$DOMAIN/privkey.pem /etc/nginx/ssl/key.pem
          fi
      fi
      
      # Container starten
      docker-compose down
      docker-compose pull
      docker-compose up -d
      
      # Health check
      sleep 10
      if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
          echo "‚úÖ Deployment successful!"
          echo "üåê App available at: https://$DOMAIN"
      else
          echo "‚ùå Deployment failed - check logs"
          docker-compose logs
          exit 1
      fi
      
      # SSL Erneuerung einrichten
      if [ "$DOMAIN" != "localhost" ]; then
          (crontab -l 2>/dev/null; echo "0 12 * * * certbot renew --quiet && docker-compose restart nginx") | crontab -
      fi

  # Health Check Script
  - path: /opt/weclapp-manager/health-check.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      
      echo "üîç Checking WeClapp Manager health..."
      
      # Docker Status
      docker-compose ps
      
      # App Health
      if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
          echo "‚úÖ Application is healthy"
      else
          echo "‚ùå Application is not responding"
          docker-compose logs weclapp-manager --tail=20
      fi
      
      # Nginx Status
      if nginx -t > /dev/null 2>&1; then
          echo "‚úÖ Nginx configuration is valid"
      else
          echo "‚ùå Nginx configuration error"
          nginx -t
      fi

# Benutzer erstellen
users:
  - name: deploy
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC3ekDdVX59biYH1uXAJzoLEg3dxZRE1vXk26fU/ryBX9bAeg7T1R58MHFMHiTONHg+34iGC71xIpUO+FETWKRsbzIupoKk/suu03VEMBk8j6Zr8KsmpLHQ45CwjSRJa0hWnAMMaLTluBnmDpY4w4H2WEyUopAKgkXbp1n099YNsR23Btd4IGRoTnvsECSSb7HcFPmHTStpxZOZoR20LRkO3o0E4N5b1teIX+jNRma/PRwPDOfYvpnYE2/xCi3v7CRTHypPD1XLF0Bfi8HJ5pvouXLUZyHfs5HYztwQNyEzWlaEjvTo0fD3z+Y6wGYcEZSV2ycpCDRI1Q5nipNayBayHQgC3TLi2tUaGsiM1XcOXx9NjdBYCKWop2hSJwEgyB/7t5WeSu3Ipd9nezSxE/TKzD88qSoMekANBjJPbY3xJ9frF/04GzaiHss2pSug1paA/OErYwTDgR8yHRrbNSjKMI7cj40PjSSiYHQfTNPm+4WRBYGC3eiUa2He+8tl9zVJGVnvC/tJbO+FeGwNhOoSlriClyGODRJih8DuI7D0zEYVGINFrRIiM1ER+FGjLvyzkZuGmzO2CXWqOE6UFVwLGmA2uOcBSj/ynYjuMTdcmOb8EKUurxGxSJ7sTLxIPqwvgQgfnqg8DM4vlMa8wrvvn//KZSQ/wtIYEZ1FinzmzQ== azuread\sebastianm√∂hrer@DWE-DESKTOP-SEBI

# Final commands
final_message: |
  üéâ WeClapp Manager Server Setup Complete!
  
  Next steps:
  1. SSH into server: ssh deploy@SERVER_IP
  2. Run deployment: cd /opt/weclapp-manager && ./deploy.sh
  3. Set your environment variables
  4. Configure your domain DNS
  
  Server IP: ${ipv4}
  Hostname: ${hostname}
